<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>browser proxy!</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:#000;overflow:hidden;font-family:system-ui;color:#fff}
  canvas{display:block;cursor:none}
  #s{position:absolute;top:20px;left:20px;background:#000c;padding:12px 20px;border-radius:12px;font:18px system-ui;z-index:10;opacity:1;transition:opacity 1s}
  #l{position:absolute;bottom:24px;left:24px;z-index:10;padding:14px 28px;background:#333;color:#fff;border:none;border-radius:16px;font:16px system-ui;cursor:pointer}
  #l:hover{background:#555}
</style>
</head>
<body>
<div id="s">getting ready..</div>
<button id="l">Click to Control</button>
<canvas id="c"></canvas>

<script>
const c=document.getElementById("c")
const ctx=c.getContext("2d")
const s=document.getElementById("s")
const l=document.getElementById("l")
c.width=1280
c.height=720

const p=new URLSearchParams(location.search)
const ws=new WebSocket(`wss://${location.host}?room=${p.get("room")||""}`)

let cursors={}
let me=Math.random().toString(36).slice(2,10)
let pos={x:c.width/2,y:c.height/2}
let locked=false
let lastFrame=0

function draw(b64,frame){
  if(frame<=lastFrame)return
  lastFrame=frame
  const i=new Image()
  i.onload=()=>{
    ctx.clearRect(0,0,c.width,c.height)
    ctx.drawImage(i,0,0,c.width,c.height)
    for(const[id,p]of Object.entries(cursors)){
      ctx.fillStyle=id===me?"#ff0066":"#00ff99"
      ctx.strokeStyle="#000"
      ctx.lineWidth=3
      ctx.beginPath()
      ctx.arc(p.x,p.y,11,0,6.28)
      ctx.fill()
      ctx.stroke()
    }
  }
  i.src="data:image/jpeg;base64,"+b64
}

ws.onmessage=e=>{
  const m=JSON.parse(e.data)
  if(m.type==="room")history.replaceState(null,"","?room="+m.room)
  if(m.type==="status")s.textContent=m.text
  if(m.type==="ready")setTimeout(()=>s.style.opacity=0.6,1500)
  if(m.type==="screenshot")draw(m.data,m.frame)
  if(m.type==="cursor")cursors[m.id]={x:m.x,y:m.y}
}

const send=o=>ws.readyState===WebSocket.OPEN&&ws.send(JSON.stringify(o))

l.onclick=()=>c.requestPointerLock()

document.addEventListener("pointerlockchange",()=>{
  locked=document.pointerLockElement===c
  l.textContent=locked?"locked in mouse":"lock mouse"
})

document.addEventListener("mousemove",e=>{
  if(locked){
    pos.x=Math.max(0,Math.min(c.width-1,pos.x+e.movementX))
    pos.y=Math.max(0,Math.min(c.height-1,pos.y+e.movementY))
  }else{
    const r=c.getBoundingClientRect()
    pos.x=e.clientX-r.left
    pos.y=e.clientY-r.top
  }
  cursors[me]=pos
  send({type:"cursor",id:me,x:pos.x,y:pos.y})
  send({type:"mouse",action:"move",x:Math.round(pos.x),y:Math.round(pos.y)})
})

const btn={0:"left",2:"right"}
c.addEventListener("mousedown",e=>send({type:"mouse",action:"down",button:btn[e.button]||"left",x:Math.round(pos.x),y:Math.round(pos.y)}))
c.addEventListener("mouseup",e=>send({type:"mouse",action:"up",button:btn[e.button]||"left",x:Math.round(pos.x),y:Math.round(pos.y)}))

window.addEventListener("keydown",e=>send({type:"keyboard",action:"down",key:e.key}))
window.addEventListener("keyup",e=>send({type:"keyboard",action:"up",key:e.key}))

ws.onopen=()=>s.textContent="Connected"
ws.onclose=()=>{s.textContent="Disconnected";s.style.opacity=1}
</script>
</body>
</html>
